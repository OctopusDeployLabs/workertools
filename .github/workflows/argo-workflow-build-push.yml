name: Build argo-workflow-workertools image

on:
  push:
    branches:
    - main
    paths:
    - argo-workflow/**
  workflow_dispatch:

env: 
    VERSION: 3.8.7-$GITHUB_RUN_NUMBER
    REGISTRY_IMAGE: lrochette/argo-workflow-workertools

jobs:
    build-linux:
        runs-on: ubuntu-latest
        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Login to DockerHub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_HUB_USER }}
            password: ${{ secrets.DOCKER_HUB_PAT }}
 
        - name: Build image
        with:
            context: argo-workflows
          run: >
            docker buildx build --platform 'linux/amd64,linux/arm64' \
                --file Dockerfile \
                --build-arg VERSION=${{ env.VERSION }} \
                --tag ${{ env.REGISTRY_IMAGE }}:${{ env.VERSION}} \
                --push .
